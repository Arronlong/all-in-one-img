<!DOCTYPE html>
<html>
<head>
	<title>掘金图床</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="icon" href="https://icon.zol-img.com.cn/favicon.ico" type="image/icon" />
	<link rel="shortcut" href="https://icon.zol-img.com.cn/favicon/180.png" type="image/icon" />
	<link rel="apple-touch-icon" href="https://icon.zol-img.com.cn/favicon/180.png"/>
	<link rel="apple-touch-icon" sizes="180x180" href="https://icon.zol-img.com.cn/favicon/180.png">
	<link rel="apple-touch-icon" sizes="192x192" href="https://icon.zol-img.com.cn/favicon/192.png">
</head>
<body>
	<h1>掘金图床</h1>
	<!-- 表单 -->
	<form id="form" enctype="multipart/form-data">
		<div id="select_file">
			选择图片文件
			<input type="file" id="fileAttach" class="file_btn" name="file" onclick="daojishi()"/>
		</div>

		<!-- 文件名显示区域 -->
		<div id="filename"></div>

		<!-- 上传按钮 -->
		<div id="upload_btn_div"></div>
	</form>


	<!-- 上传状态 -->
	<div id="status"><div>

	<!-- 上传结果 -->
	<div id="imgdiv"><img src="http://user-gold-cdn.xitu.io/2020/4/23/171a5508b2afe015"/><div>
	
	<!-- 引入Jquery -->
	<script src="https://www.jq22.com/jquery/jquery-3.3.1.js"></script>

	<!-- 轮询文件名 -->
	<script>
	    function daojishi() {
	        setInterval("getname()",1000);
	    }
	</script>

	<!-- 获取文件名 -->
	<script>
	    function getname() {
	        var filename = $("#select_file .file_btn").val();
	        $("#filename").text(filename);
	        if (filename) {
	        	$("#upload_btn_div").html("<input type=\"button\" onclick=\"upload()\" id=\"file_upload_btn\" value=\"上传\"/>");
	        }else{
	        	//
	        }
	    }
	</script>

	<!-- Ajax上传 -->
	<script>
		function upload(){
			var form = new FormData(document.getElementById("form"));
			$.ajax({
				//先把图片上传到自己的服务器的upload文件夹
				url:"upload.php",
				type:"post",
				data:form,
				cache: false,
				processData: false,
				contentType: false,
				success:function(data){
					if (data.res == "400") {
						$("#imgdiv").html("<img src='uploading.gif'/>");
						var imgfile = data.path;
						//再把自己服务器的图片上传到SOHU服务器，上传成功后，删掉自己服务器的图片
						$.ajax({
							url:"juejin.php?path=" + imgfile,
							type:"post",
							cache: false,
							processData: false,
							contentType: false,
							success:function(data){
								if (data.m == "ok") {
									//截取url
									var imgurl = data.d.url.http;
									url = imgurl.match(/(\S*)\?w=/)[1];
									$("#imgdiv").html("<img src=\""+url+"\"/>");
								}else{
									alert("上传失败");
								}
								
							},
							error:function(data){
								alert("上传到掘金服务器失败了");
							}
						})
					}else if (data.res == "403") {
						$("#upload-result").text("格式不对");
					}else if (data.res == "404") {
						$("#upload-result").text("上传错误");
					}
					
				},
				error:function(data){
					alert("上传到服务器失败");
				}
			})
		}
	</script>
</body>
</html>